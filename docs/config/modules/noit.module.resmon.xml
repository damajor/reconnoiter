<?xml version="1.0"?>
<section xmlns="http://docbook.org/ns/docbook" version="5">
  <title>resmon</title>
  <para>The resmon module performs services checks against an HTTP server serving with Resmon XML or JSON.</para>
  <para><link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://labs.omniti.com/trac/resmon"><citetitle>Resmon</citetitle></link> is a light-weight resource monitor that exposes health of services over HTTP in XML.</para>
  <para>This module rides on the http module and provides a secondary phase of XML parsing on the contents that extracts Resmon status messages into metrics that can be trended.</para>
  <variablelist>
    <varlistentry>
      <term>loader</term>
      <listitem>
        <para>lua</para>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>object</term>
      <listitem>
        <para>noit.module.resmon</para>
      </listitem>
    </varlistentry>
  </variablelist>
  <section>
    <title>Check Configuration</title>
    <variablelist>
      <varlistentry>
        <term>url</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>required</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The URL including schema and hostname (as you would type into a browser's location bar).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>port</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The TCP port can be specified to overide the default of 81.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>method</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>GET</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The HTTP method to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>payload</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The optional HTTP payload to send with the request.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>http_version</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>1.1</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>^(\d+\.\d+)?$</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Sets the HTTP version for the check to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_method</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>^(?:Basic|Digest|Auto)$</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>HTTP Authentication method to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_user</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>[^:]*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The user to authenticate as.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_password</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The password to use during authentication.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>ca_chain</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing all the certificate authorities that should be loaded to validate the remote certificate (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>certificate_file</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing the client certificate that will be presented to the remote server (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>key_file</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing key to be used in conjunction with the cilent certificate (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>ciphers</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A list of ciphers to be used in the SSL protocol (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>read_limit</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>0</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Sets an approximate limit on the data read (0 means no limit).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>header_(\S+)</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Allows the setting of arbitrary HTTP headers in the request.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <section>
    <title>Examples</title>
    <example>
      <title>Checking resmon services on OmniTI Labs.</title>
      <para>This example checks the Resmon service on OmniTI Labs.</para>
      <programlisting>
      &lt;noit&gt;
        &lt;modules&gt;
          &lt;loader image="lua" name="lua"&gt;
            &lt;config&gt;&lt;directory&gt;/opt/reconnoiter/libexec/modules-lua/?.lua&lt;/directory&gt;&lt;/config&gt;
          &lt;/loader&gt;
          &lt;module loader="lua" name="resmon" object="noit.module.resmon"/&gt;
        &lt;/modules&gt;
        &lt;checks&gt;
          &lt;labs target="8.8.38.5" module="resmon"&gt;
            &lt;check uuid="36b8ba72-7968-11dd-a67f-d39a2cc3f9de"&gt;
              &lt;config&gt;
                &lt;auth_user&gt;foo&lt;/auth_user&gt;
                &lt;auth_password&gt;bar&lt;/auth_password&gt;
              &lt;/config&gt;
            &lt;/check&gt;
          &lt;/labs&gt;
        &lt;/checks&gt;
      &lt;/noit&gt;
    </programlisting>
    </example>
  </section>
</section>
